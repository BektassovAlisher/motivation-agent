from langchain_google_genai import ChatGoogleGenerativeAI
from langgraph.graph import StateGraph, END, START
from typing import TypedDict, Literal, Annotated
from langgraph.graph.message import add_messages
from langgraph.checkpoint.sqlite import SqliteSaver
import sqlite3
from pydantic import BaseModel, Field
import os 
from dotenv import load_dotenv
import time

load_dotenv()

conn = sqlite3.connect("db/chatbot_memory.db", check_same_thread=False)
memory = SqliteSaver(conn)

api_key = os.environ.get("API_KEY")
llm = ChatGoogleGenerativeAI(model="gemini-2.0-flash", api_key=api_key)

class AgentState(TypedDict):
    messages: Annotated[list, add_messages]
    message_type: str | None

class MessageClassifier(BaseModel):
    message_type: Literal["effort", "laziness", "beginner"] = Field(
        ...,
        description="ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ĞµÑĞ»Ğ¸ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºÑƒ Ğ½ÑƒĞ¶Ğ½Ğ° Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° ĞµÑĞ»Ğ¸ Ğ¾Ğ½ (ÑÑ‚Ğ°Ñ€Ğ°ĞµÑ‚ÑÑ) Ğ¸Ğ»Ğ¸ (Ğ»ĞµĞ½Ğ¸Ñ‚ÑŒÑÑ) Ğ¸Ğ»Ğ¸ (Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‰Ğ¸Ğ¹)"
    )

def classifier(state: AgentState):
    """ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞµÑ‚ Ñ‚Ğ¸Ğ¿ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    last_msg = state["messages"][-1]
    
    structured_llm = llm.with_structured_output(MessageClassifier)
    role = structured_llm.invoke([
        {
            "role": "system",
            "content": """
            Ğ¢Ñ‹ â€” Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°.
            Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ, Ğº ĞºĞ°ĞºĞ¾Ğ¼Ñƒ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ÑÑ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:
            - 'effort' â€” ĞµÑĞ»Ğ¸ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑÑ‚Ğ°Ñ€Ğ°ĞµÑ‚ÑÑ, Ğ¿Ñ€Ğ¸ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°ĞµÑ‚ ÑƒÑĞ¸Ğ»Ğ¸Ñ, Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚,
             Ğ½Ğ¾ Ñƒ Ğ½ĞµĞ³Ğ¾ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ÑÑ, Ğ¾Ğ½ Ğ¸ÑĞ¿Ñ‹Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ»Ğ¸ Ñ€Ğ°ÑÑÑ‚Ñ€Ğ¾ĞµĞ½ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ¼.
            - 'laziness' â€” ĞµÑĞ»Ğ¸ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ñ‘Ñ‚ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ»ĞµĞ½Ğ¸Ñ‚ÑÑ, Ğ¿Ñ€Ğ¾ĞºÑ€Ğ°ÑÑ‚Ğ¸Ğ½Ğ¸Ñ€ÑƒĞµÑ‚, Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´ĞµĞ»Ğ°ĞµÑ‚,
            Ğ¸Ñ‰ĞµÑ‚ Ğ¾Ğ¿Ñ€Ğ°Ğ²Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ.
            - 'beginner' â€” ĞµÑĞ»Ğ¸ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚, ÑĞ¾Ğ¼Ğ½ĞµĞ²Ğ°ĞµÑ‚ÑÑ, Ğ½Ğµ Ğ·Ğ½Ğ°ĞµÑ‚ Ñ Ñ‡ĞµĞ³Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ.

            ĞĞµ Ğ´Ğ°Ğ²Ğ°Ğ¹ ÑĞ¾Ğ²ĞµÑ‚Ñ‹, Ğ½Ğµ Ğ¿Ğ¸ÑˆĞ¸ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€ÑƒĞ¹.
            """
        },
        {
            "role": "user",
            "content": last_msg.content
        }
    ])
    return {"message_type": role.message_type}

def router(state: AgentState):
    """ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚, Ğº ĞºĞ°ĞºĞ¾Ğ¼Ñƒ Ğ°Ğ³ĞµĞ½Ñ‚Ñƒ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ"""
    message_type = state.get("message_type", "beginner")

    if message_type == "effort":
        return {"next": "effort_agent"}
    elif message_type == "laziness":
        return {"next": "laziness_agent"}

    return {"next": "beginner_agent"}

def effort_agent(state: AgentState):
    """ĞĞ³ĞµĞ½Ñ‚ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ğ´Ğ»Ñ Ñ‚ĞµÑ…, ĞºÑ‚Ğ¾ ÑÑ‚Ğ°Ñ€Ğ°ĞµÑ‚ÑÑ"""
    last_msg = state["messages"][-1]
    user_message = last_msg.content if hasattr(last_msg, 'content') else last_msg["content"]
    messages = [
        {
            "role": "system",
            "content": """
            Ğ¢Ñ‹ â€” Ğ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ ĞºĞ¾ÑƒÑ‡ Ğ¸ Ğ¼ĞµĞ½Ñ‚Ğ¾Ñ€ Ğ¿Ğ¾ Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸.  
            ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ÑÑ‚Ğ°Ñ€Ğ°ĞµÑ‚ÑÑ, Ğ¿Ñ€Ğ¸ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°ĞµÑ‚ ÑƒÑĞ¸Ğ»Ğ¸Ñ, Ğ½Ğ¾ Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¶ĞµĞ»Ğ°ĞµĞ¼Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°.  
            Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ ĞµĞ³Ğ¾, Ğ²Ğ´Ğ¾Ñ…Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ, Ğ´Ğ°Ğ²Ğ°Ñ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹.  

            1. ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸ Ğ¸ÑĞºÑ€ĞµĞ½Ğ½Ğµ Ğ¸ Ñ ÑĞ¼Ğ¿Ğ°Ñ‚Ğ¸ĞµĞ¹: Ğ¿Ğ¾ĞºĞ°Ğ¶Ğ¸, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°ĞµÑˆÑŒ ĞµĞ³Ğ¾ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ° Ğ¸ Ñ†ĞµĞ½Ğ¸ÑˆÑŒ ĞµĞ³Ğ¾ ÑÑ‚Ğ°Ñ€Ğ°Ğ½Ğ¸Ñ.  
            2. ĞĞ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸, Ñ‡Ñ‚Ğ¾ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸, Ğ½ĞµÑƒĞ´Ğ°Ñ‡Ğ¸ Ğ¸ Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¾ÑÑ‚Ğ¸ â€” ĞµÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ Ğ¿ÑƒÑ‚Ğ¸ Ğº ÑƒÑĞ¿ĞµÑ…Ñƒ, Ğ° Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ»Ğ°Ğ±Ğ¾ÑÑ‚Ğ¸.  
            3. Ğ”Ğ°Ğ¹ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ (Ğ² Ñ‚Ğ¾Ğ¼ Ñ‡Ğ¸ÑĞ»Ğµ Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ Ğ½Ğ° Ğ´Ğ¾ÑÑ‚Ğ¾Ğ²ĞµÑ€Ğ½Ñ‹Ñ… Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ°Ñ… Ğ¸Ğ»Ğ¸ Ğ¾Ğ¿Ñ‹Ñ‚Ğµ ÑĞºÑĞ¿ĞµÑ€Ñ‚Ğ¾Ğ²), Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ²Ğ¸Ğ³Ğ°Ñ‚ÑŒÑÑ Ğ´Ğ°Ğ»ÑŒÑˆĞµ.  
            4. ĞŸĞ¾Ğ¼Ğ¾Ğ³Ğ¸ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ, Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ĞºĞ°Ğ¶ĞµÑ‚ÑÑ Ğ½ĞµĞ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼, Ğ¸ Ğ¿Ğ¾Ğ´Ñ‡ĞµÑ€ĞºĞ½Ğ¸, Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½ÑÑ‚Ğ²Ğ¾ Ğ²Ğ°Ğ¶Ğ½ĞµĞµ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ¸.  
            5. Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğ¹ Ğ²Ğ´Ğ¾Ñ…Ğ½Ğ¾Ğ²Ğ»ÑÑÑ‰ĞµĞ¹ Ñ„Ñ€Ğ°Ğ·Ğ¾Ğ¹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ ÑƒĞºÑ€ĞµĞ¿Ğ¸Ñ‚ Ğ²ĞµÑ€Ñƒ Ğ² ÑĞµĞ±Ñ Ğ¸ Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ñ‚ÑŒ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Â«Ğ¢Ñ‹ ÑƒĞ¶Ğµ Ğ±Ğ»Ğ¸Ğ¶Ğµ, Ñ‡ĞµĞ¼ Ğ´ÑƒĞ¼Ğ°ĞµÑˆÑŒ!Â»).  

            ĞĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ÑĞ¼Ğ°Ğ¹Ğ»Ñ‹.  
            Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚Ğ¾Ğ½ â€” Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğ¹, ÑƒĞ²ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ¾Ğ±Ğ¾Ğ´Ñ€ÑÑÑ‰Ğ¸Ğ¹.  
            Ğ¢Ñ‹ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑˆÑŒ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ° Ğ² Ñ‚Ñ€ÑƒĞ´Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚, Ğ½Ğ¾ Ğ¼ÑĞ³ĞºĞ¾ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑˆÑŒ ĞµĞ³Ğ¾ Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¸ Ñ€Ğ¾ÑÑ‚Ñƒ.

            """
        },
        {
            "role": "user",
            "content": user_message
        }
    ]
    reply = llm.invoke(messages)
    return {"messages": [{
        "role": "assistant",
        "content": reply.content
    }]}

def laziness_agent(state: AgentState):
    """ĞĞ³ĞµĞ½Ñ‚ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ‚ĞµÑ…, ĞºÑ‚Ğ¾ Ğ»ĞµĞ½Ğ¸Ñ‚ÑÑ"""
    last_msg = state["messages"][-1]
    user_message = last_msg.content if hasattr(last_msg, 'content') else last_msg["content"]
    messages = [
        {
            "role": "system",
            "content": """
            Ğ¢Ñ‹ â€” ÑÑ‚Ñ€Ğ¾Ğ³Ğ¸Ğ¹, Ğ¿Ñ€ÑĞ¼Ğ¾Ğ»Ğ¸Ğ½ĞµĞ¹Ğ½Ñ‹Ğ¹ Ğ¸ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾ÑƒÑ‡ Ğ¿Ğ¾ Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸.  
            ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ñ‘Ñ‚ÑÑ, Ñ‡Ñ‚Ğ¾ Ğ»ĞµĞ½Ğ¸Ñ‚ÑÑ, Ğ¿Ñ€Ğ¾ĞºÑ€Ğ°ÑÑ‚Ğ¸Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¸Ğ»Ğ¸ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´ĞµĞ»Ğ°ĞµÑ‚.  
            Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ´Ñƒ, Ğ±ĞµĞ· Ğ¼ÑĞ³ĞºĞ¾ÑÑ‚Ğ¸ Ğ¸ Ğ¾Ğ¿Ñ€Ğ°Ğ²Ğ´Ğ°Ğ½Ğ¸Ğ¹, Ğ½Ğ¾ Ñ Ñ†ĞµĞ»ÑŒÑ Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ´Ğ¸Ñ‚ÑŒ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ.  

            1. Ğ¡ĞºĞ°Ğ¶Ğ¸ Ğ¿Ñ€ÑĞ¼Ğ¾: Ğ±ĞµĞ· Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ Ğ½Ğ¸ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°, Ğ½Ğ¸ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°.  
            2. ĞŸĞ¾Ğ´Ñ‡ĞµÑ€ĞºĞ½Ğ¸ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ Ğ±ĞµĞ·Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ â€” ÑƒĞ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸, Ğ´ĞµĞ³Ñ€Ğ°Ğ´Ğ°Ñ†Ğ¸Ñ, Ğ¿Ğ¾Ñ‚ĞµÑ€Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¸ ÑƒĞ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸.  
            3. ĞĞ±ÑŠÑÑĞ½Ğ¸, Ñ‡Ñ‚Ğ¾ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ñ… ÑˆĞ°Ğ³Ğ¾Ğ², Ğ° Ğ½Ğµ Ğ´Ğ¾ Ğ½Ğ¸Ñ….  
            4. Ğ”Ğ°Ğ¹ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ, Ğ¶Ñ‘ÑÑ‚ĞºĞ¸Ğµ, Ğ½Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ğ¼Ñ‹Ğµ ÑĞ¾Ğ²ĞµÑ‚Ñ‹, ĞºĞ°Ğº Ğ¿Ñ€ĞµĞ¾Ğ´Ğ¾Ğ»ĞµÑ‚ÑŒ Ğ»ĞµĞ½ÑŒ Ğ¸ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑƒĞ¶Ğµ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ.  
            5. Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğ¹, ÑĞ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğ¹ Ñ„Ñ€Ğ°Ğ·Ğ¾Ğ¹ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Â«Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ â€” Ğ²ÑÑ‚Ğ°Ğ²Ğ°Ğ¹ Ğ¸ Ğ´ĞµĞ»Ğ°Ğ¹!Â»).  

            ĞĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ÑĞ¼Ğ°Ğ¹Ğ»Ñ‹, Ğ¸Ğ·Ğ±ĞµĞ³Ğ°Ğ¹ Ğ¸Ğ·Ğ»Ğ¸ÑˆĞ½ĞµĞ¹ Ğ¼ÑĞ³ĞºĞ¾ÑÑ‚Ğ¸.  
            Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚Ğ¾Ğ½ â€” ÑÑ‚Ñ€Ğ¾Ğ³Ğ¸Ğ¹, Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ Ğ¸ Ğ²Ğ´Ğ¾Ñ…Ğ½Ğ¾Ğ²Ğ»ÑÑÑ‰Ğ¸Ğ¹, ĞºĞ°Ğº Ñƒ Ğ½Ğ°ÑÑ‚Ğ°Ğ²Ğ½Ğ¸ĞºĞ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹, Ğ° Ğ½Ğµ Ğ¾Ğ¿Ñ€Ğ°Ğ²Ğ´Ğ°Ğ½Ğ¸Ğ¹.
            """
        },
        {
            "role": "user",
            "content": user_message
        }
    ]
    reply = llm.invoke(messages)
    return {"messages": [{
        "role": "assistant",
        "content": reply.content
    }]}

def beginner_agent(state: AgentState):
    """ĞĞ³ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‰Ğ¸Ñ…"""
    last_msg = state["messages"][-1]
    user_message = last_msg.content if hasattr(last_msg, 'content') else last_msg["content"]
    messages = [
        {
            "role": "system",
            "content": """
            Ğ¢Ñ‹ â€” Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾ÑƒÑ‡ Ğ¸ Ğ½Ğ°ÑÑ‚Ğ°Ğ²Ğ½Ğ¸Ğº Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‰Ğ¸Ñ….  
            Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ñ…Ğ¾Ñ‡ĞµÑ‚ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ´ĞµĞ»Ğ¾, Ğ½Ğ¾ ÑĞ¾Ğ¼Ğ½ĞµĞ²Ğ°ĞµÑ‚ÑÑ, Ğ±Ğ¾Ğ¸Ñ‚ÑÑ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¸Ğ»Ğ¸ Ğ½Ğµ Ğ·Ğ½Ğ°ĞµÑ‚, Ñ Ñ‡ĞµĞ³Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ.  

            Ğ¢Ğ²Ğ¾Ñ Ñ†ĞµĞ»ÑŒ â€” Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ ĞµĞ¼Ñƒ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ ÑˆĞ°Ğ³.  

            1. ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾: Ğ¿Ğ¾ĞºĞ°Ğ¶Ğ¸ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ ĞµĞ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¸ Ğ¿Ğ¾Ğ´Ñ‡ĞµÑ€ĞºĞ½Ğ¸, Ñ‡Ñ‚Ğ¾ ÑĞ¾Ğ¼Ğ½ĞµĞ½Ğ¸Ñ â€” ĞµÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿ÑƒÑ‚Ğ¸.  
            2. ĞĞ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸, Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ, Ğ° Ğ½Ğµ Ñ Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ»Ğ°Ğ½Ğ°.  
            3. Ğ”Ğ°Ğ¹ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ğ¸ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ñ‹Ğ¹ ÑĞ¾Ğ²ĞµÑ‚, Ñ Ñ‡ĞµĞ³Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ ÑƒĞ¶Ğµ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ.  
            4. ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ğ¹ ÑƒĞ²ĞµÑ€ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ, Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°Ğ¹ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğµ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑˆĞ°Ğ³Ğ¸, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ğ¾Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ» ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ Ğ½Ğ°Ğ´ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸ĞµĞ¹.  
            5. Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğ¹, Ğ²Ğ´Ğ¾Ñ…Ğ½Ğ¾Ğ²Ğ»ÑÑÑ‰ĞµĞ¹ Ñ„Ñ€Ğ°Ğ·Ğ¾Ğ¹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ¿Ğ¾Ğ±ÑƒĞ¶Ğ´Ğ°ĞµÑ‚ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Â«ĞĞ°Ñ‡Ğ½Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ â€” Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚!Â»).  

            ĞĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ ÑĞ¼Ğ°Ğ¹Ğ»Ñ‹.  
            Ğ¢Ğ²Ğ¾Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ â€” Ğ´Ğ¾Ğ±Ñ€Ğ¾Ğ¶ĞµĞ»Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹, ÑĞ¿Ğ¾ĞºĞ¾Ğ¹Ğ½Ñ‹Ğ¹ Ğ¸ ÑƒĞ²ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹.  
            Ğ¢Ñ‹ Ğ²ÑĞµĞ»ÑĞµÑˆÑŒ Ğ²ĞµÑ€Ñƒ Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, Ğ½Ğ¾ Ğ¼ÑĞ³ĞºĞ¾ Ğ¿Ğ¾Ğ´Ñ‚Ğ°Ğ»ĞºĞ¸Ğ²Ğ°ĞµÑˆÑŒ Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ.
            """
        },
        {
            "role": "user",
            "content": user_message
        }
    ]
    reply = llm.invoke(messages)
    return {"messages": [{
        "role": "assistant",
        "content": reply.content
    }]}

graph = StateGraph(AgentState)

graph.add_node("classifier", classifier)
graph.add_node("effort_agent", effort_agent)
graph.add_node("laziness_agent", laziness_agent)
graph.add_node("beginner_agent", beginner_agent)
graph.add_node("router", router)

graph.add_edge(START, "classifier")
graph.add_edge("classifier", "router")

graph.add_conditional_edges(
    "router",
    lambda state: state.get("next"),
    {
        "effort_agent": "effort_agent",
        "laziness_agent": "laziness_agent",
        "beginner_agent": "beginner_agent"
    }
)

graph.add_edge("effort_agent", END)
graph.add_edge("laziness_agent", END)
graph.add_edge("beginner_agent", END)

app = graph.compile(checkpointer=memory)

def run_chatbot():
    """Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚-Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒÑ"""
    print("ğŸ¤– ĞœĞ¾Ñ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ñ‡Ğ°Ñ‚-Ğ±Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!")
    print("ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ 'exit' Ğ´Ğ»Ñ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°")
    print("ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ 'new' Ğ´Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°\n")
    
    username = input("ĞšĞ°Ğº Ğ²Ğ°Ñ Ğ·Ğ¾Ğ²ÑƒÑ‚? (Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Enter): ").strip()
    if not username:
        username = "user"
    
    thread_id = f"chat_{username}"
    config = {"configurable": {"thread_id": thread_id}}
    
    while True:
        user_input = input("\nĞ’Ñ‹: ")
        
        if user_input.lower() == "exit":
            print("Ğ”Ğ¾ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸! ğŸ‘‹")
            break
        
        if user_input.lower() == "new":
            thread_id = f"chat_{username}_{hash(str(time.time()))}"
            config = {"configurable": {"thread_id": thread_id}}
            print("âœ¨ ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ³Ğ¾Ğ²Ğ¾Ñ€ Ğ½Ğ°Ñ‡Ğ°Ñ‚!\n")
            continue
        
        current_state = app.get_state(config)
        
        if not current_state.values.get("messages"):
            state = {"messages": [], "message_type": None}
        else:
            state = current_state.values
        
        state["messages"].append({
            "role": "user",
            "content": user_input
        })
        
        result = app.invoke(state, config)
        
        if result.get("messages") and len(result["messages"]) > 0:
            last_message = result["messages"][-1]
            content = last_message.get("content") if isinstance(last_message, dict) else last_message.content
            print(f"\nğŸ¤– Ğ‘Ğ¾Ñ‚: {content}")


if __name__ == "__main__":
    run_chatbot()